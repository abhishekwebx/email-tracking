(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,19410,e=>{"use strict";var t=e.i(44589),a=e.i(84576),s=e.i(56262),r=e.i(92927),l=e.i(89775);function i({emailId:e}){let i,n=(0,r.useRouter)(),o=(0,r.useSearchParams)().get("template"),[d,c]=(0,a.useState)([]),[u,m]=(0,a.useState)(""),[h,f]=(0,a.useState)(""),[p,j]=(0,a.useState)(""),[y,b]=(0,a.useState)(""),[x,g]=(0,a.useState)(!1),[S,v]=(0,a.useState)(null),[N,w]=(0,a.useState)(!1),[E,T]=(0,a.useState)(e||null),[k,A]=(0,a.useState)([]),[C,_]=(0,a.useState)("");(0,a.useEffect)(()=>{(async()=>{try{let e=await fetch("/api/templates?limit=50"),t=await e.json();A(Array.isArray(t.data)?t.data:[])}catch(e){console.error("Template load error",e)}})()},[]),(0,a.useEffect)(()=>{if(!o||!Array.isArray(k))return;let e=k.find(e=>e._id===o);e&&(_(e._id),f(e.subject||""),j(e.body||""))},[o,k]),(0,a.useEffect)(()=>{let e=JSON.parse(localStorage.getItem("user")||"{}");b(e?.email||"")},[]),(0,a.useEffect)(()=>{e&&(async()=>{try{let t=await fetch(`/api/emails/${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=await t.json();if(!t.ok)throw Error(a.error);c(a.to||[]),f(a.subject||""),j(a.body||""),b(a.senderName||""),T(a._id)}catch(e){console.error("Draft load error",e)}})()},[e]);let D=()=>d.length>0&&""!==h.trim()&&""!==p.trim(),O=async()=>{g(!0),v(null);try{let e=await fetch("/api/draft",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({id:E,senderName:y,to:d,subject:h,body:p})}),t=await e.json();if(!e.ok)throw Error(t.error);T(t._id),n.push("/crm/draft-mail")}catch(e){v(e.message||"Failed to save draft")}finally{g(!1)}},$=async()=>{if(!D())return void v("All fields are required");g(!0),v(null);try{let e=await fetch("/api/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({id:E,to:d,subject:h,body:p,senderName:y})}),t=await e.json();if(!e.ok)throw Error(t.error);w(!0),c([]),f(""),j(""),T(null)}catch(e){v(e.message||"Failed to send email")}finally{g(!1)}};return(0,t.jsx)(s.default,{children:(0,t.jsx)("div",{className:"container",children:(0,t.jsxs)("div",{className:"card",children:[(0,t.jsx)("h1",{children:"Send Email"}),(0,t.jsx)("p",{className:"subtitle",children:"Track opens in real-time"}),S&&(0,t.jsx)("div",{className:"error",children:S}),N&&(0,t.jsx)("div",{className:"success",children:"Email sent successfully!"}),(0,t.jsxs)("div",{className:"mb-6",children:[(0,t.jsx)("label",{className:"block text-sm font-semibold mb-2",children:"Select Template"}),(0,t.jsxs)("select",{value:C,onChange:e=>{var t;let a;return _(t=e.target.value),void((a=k.find(e=>e._id===t))&&(f(a.subject||""),j(a.body||"")))},className:"w-full border rounded-xl px-4 py-3",children:[(0,t.jsx)("option",{value:"",children:"Choose Template"}),Array.isArray(k)&&k.map(e=>(0,t.jsxs)("option",{value:e._id,children:[e.title,e.category?` (${e.category})`:""]},e._id))]}),C&&(0,t.jsx)("div",{className:"mt-4 border rounded-xl p-4 bg-indigo-50",children:(i=k.find(e=>e._id===C))?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h3",{className:"font-semibold text-indigo-700",children:i.title}),(0,t.jsx)("p",{className:"text-sm mt-2",children:i.subject})]}):null})]}),(0,t.jsx)("label",{children:"To"}),(0,t.jsxs)("div",{className:"email-wrapper",children:[d.map(e=>(0,t.jsxs)("span",{className:"chip",children:[e,(0,t.jsx)("button",{onClick:()=>{c(d.filter(t=>t!==e))},children:"Ã—"})]},e)),(0,t.jsx)("input",{type:"email",placeholder:"Type email & press Enter",value:u,onChange:e=>m(e.target.value),onKeyDown:e=>{if("Enter"===e.key&&u.trim()){var t;let a;e.preventDefault(),(a=t=(t=u).trim(),/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))?(d.includes(t)||c([t,...d]),m(""),v(null)):v("Invalid email format")}},onPaste:e=>{e.clipboardData.getData("text").split(/[,;\s]+/).forEach(e=>{/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&!d.includes(e)&&c(t=>[e,...t])}),e.preventDefault()}})]}),(0,t.jsx)("label",{children:"Subject"}),(0,t.jsx)("input",{value:h,onChange:e=>f(e.target.value)}),(0,t.jsx)("label",{children:"Message"}),(0,t.jsx)(l.default,{body:p,setBody:j}),(0,t.jsx)("button",{className:"send-button ml-2",onClick:O,disabled:x,children:x?"Saving...":"Save Email as Draft"}),(0,t.jsx)("button",{className:"send-button",onClick:$,disabled:!D(),children:x?"Sending...":"Send Email"})]})})})}e.s(["default",()=>i])}]);