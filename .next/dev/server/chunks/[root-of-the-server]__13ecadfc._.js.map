{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///home/hp/Desktop/email-traking%20sainty/email-tracking-next/lib/sanity.ts"],"sourcesContent":["import { createClient } from \"@sanity/client\";\n\n// export const sanity = createClient({\n//   projectId: 'lgzekbmp',\n//   dataset: \"production\",\n//   apiVersion: \"2024-01-01\",\n//   useCdn: false,\n//   token: 'sk8SI0h8a7NRypPIhe36dNQhZJWuS0Do22aKeFwLo4EKbUl9ihHeI3zhXyP9OKkZCDIZ6C2jkCXFcc9t8DMctKvF7jHqghh0Nu1NsP1LeT87OAyKhGGzWyRvidBu4GGpBRXRnHWECSQy3P28l5S6Io56kzHIXtahUCH9eT7mT9Ew7SzIxujV',\n// });\n\n\n\nexport const sanity = createClient({\n  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID!,\n  dataset: 'production',\n  apiVersion: '2024-01-01',\n  token: process.env.SANITY_API_TOKEN,\n  useCdn: false,\n})\n\n\n// async function deleteAllEmails() {\n//   try {\n//     // GROQ query to fetch all email _id's\n//     const emails = await sanity.fetch(`*[_type == \"emails\"]{_id}`);\n    \n//     // Delete all emails\n//     const deletePromises = emails.map((email: { _id: any; }) => sanity.delete(email._id));\n//     await Promise.all(deletePromises);\n\n//     console.log('All emails deleted successfully!');\n//   } catch (err) {\n//     console.error('Error deleting emails:', err);\n//   }\n// }\n\n// deleteAllEmails();\n"],"names":[],"mappings":";;;;AAAA;;AAYO,MAAM,SAAS,IAAA,oQAAY,EAAC;IACjC,SAAS;IACT,SAAS;IACT,YAAY;IACZ,OAAO,QAAQ,GAAG,CAAC,gBAAgB;IACnC,QAAQ;AACV,GAGA,qCAAqC;CACrC,UAAU;CACV,6CAA6C;CAC7C,sEAAsE;CAEtE,2BAA2B;CAC3B,6FAA6F;CAC7F,yCAAyC;CAEzC,uDAAuD;CACvD,oBAAoB;CACpB,oDAAoD;CACpD,MAAM;CACN,IAAI;CAEJ,qBAAqB"}},
    {"offset": {"line": 172, "column": 0}, "map": {"version":3,"sources":["file:///home/hp/Desktop/email-traking%20sainty/email-tracking-next/app/api/send/route.ts"],"sourcesContent":["// import { NextResponse } from \"next/server\";\n// import nodemailer from \"nodemailer\";\n// import { sanity } from \"@/lib/sanity\";\n// import jwt from \"jsonwebtoken\";\n\n// // ✅ Track links\n// function trackLinks(html: string, emailId: string) {\n//   return html.replace(\n//     /href=\"(.*?)\"/g,\n//     (_, url) =>\n//       `href=\"${process.env.NEXT_PUBLIC_BASE_URL}/api/click?id=${emailId}&url=${encodeURIComponent(url)}\"`\n//   );\n// }\n\n// // ✅ Create transporter once\n// const transporter = nodemailer.createTransport({\n//   service: \"gmail\",\n//   auth: {\n//     user: process.env.MAIL_USER,\n//     pass: process.env.MAIL_PASS,\n//   },\n// });\n\n// export async function POST(req: Request) {\n//   try {\n//     const authHeader = req.headers.get(\"authorization\");\n\n//     if (!authHeader) {\n//       return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n//     }\n\n//     const token = authHeader.replace(\"Bearer \", \"\");\n//     // eslint-disable-next-line @typescript-eslint/no-explicit-any\n//     const decoded: any = jwt.verify(token, process.env.JWT_SECRET!);\n\n//     const { to, subject, body, senderName } = await req.json();\n\n//     const recipients: string[] = Array.isArray(to)\n//       ? to\n//       : to.split(\",\").map((e: string) => e.trim());\n\n//     if (!recipients.length || !subject || !body) {\n//       return NextResponse.json(\n//         { error: \"Missing fields\" },\n//         { status: 400 }\n//       );\n//     }\n\n//     for (const recipient of recipients) {\n\n//       const emailDoc = await sanity.create({\n//         _type: \"emails\",\n\n//         user: {\n//           _type: \"reference\",\n//           _ref: decoded.userId,\n//         },\n\n//         to: [recipient], // ✅ ALWAYS ARRAY\n//         subject,\n//         body,\n//         senderName,\n\n//         status: \"sent\",\n\n//         sentAt: new Date().toISOString(),\n//         createdAt: new Date().toISOString(),\n\n//         openCount: 0,\n//         clickCount: 0,\n//       });\n\n//       const trackedBody = trackLinks(body, emailDoc._id);\n\n//       const pixel = `\n//         <img src=\"${process.env.NEXT_PUBLIC_BASE_URL}/api/open?id=${emailDoc._id}\"\n//         width=\"1\" height=\"1\" style=\"display:none;\" />\n//       `;\n\n//       await transporter.sendMail({\n//         from: `\"${senderName || \"CRM\"}\" <${process.env.MAIL_USER}>`,\n//         replyTo: decoded.email,\n//         to: recipient,\n//         subject,\n//         html: trackedBody + pixel,\n//       });\n//     }\n\n//     return NextResponse.json({ success: true });\n\n//   // eslint-disable-next-line @typescript-eslint/no-explicit-any\n//   } catch (error: any) {\n//     return NextResponse.json(\n//       { error: error.message },\n//       { status: 500 }\n//     );\n//   }\n// }\n\nimport { NextResponse } from \"next/server\";\nimport nodemailer from \"nodemailer\";\nimport { sanity } from \"@/lib/sanity\";\nimport jwt from \"jsonwebtoken\";\n\n// ✅ Track links for click tracking\nfunction trackLinks(html: string, emailId: string) {\n  return html.replace(\n    /href=\"(.*?)\"/g,\n    (_, url) =>\n      `href=\"${process.env.NEXT_PUBLIC_BASE_URL}/api/click?id=${emailId}&url=${encodeURIComponent(\n        url,\n      )}\"`,\n  );\n}\n\n// ✅ Create transporter once\nconst transporter = nodemailer.createTransport({\n  service: \"gmail\",\n  auth: {\n    user: process.env.MAIL_USER,\n    pass: process.env.MAIL_PASS,\n  },\n});\n\nexport async function POST(req: Request) {\n  try {\n    const authHeader = req.headers.get(\"authorization\");\n    if (!authHeader) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const token = authHeader.replace(\"Bearer \", \"\");\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const decoded: any = jwt.verify(token, process.env.JWT_SECRET!);\n\n    const { id: draftId, to, subject, body, senderName } = await req.json();\n\n    // Normalize recipients\n    const recipients: string[] = Array.isArray(to)\n      ? to\n      : typeof to === \"string\"\n        ? to.split(\",\").map((e) => e.trim())\n        : [];\n\n    if (!recipients.length || !subject || !body) {\n      return NextResponse.json({ error: \"Missing fields\" }, { status: 400 });\n    }\n\n    // ✅ Update existing draft if id exists\n    let emailDoc;\n    if (draftId) {\n      emailDoc = await sanity\n        .patch(draftId)\n        .set({\n          status: \"sent\",\n          sentAt: new Date().toISOString(),\n          subject,\n          body,\n          senderName,\n          to: recipients,\n          updatedAt: new Date().toISOString(),\n        })\n        .commit();\n    } else {\n      // ✅ Create new email document\n      emailDoc = await sanity.create({\n        _type: \"emails\",\n        user: { _type: \"reference\", _ref: decoded.userId },\n        to: recipients,\n        subject,\n        body,\n        senderName,\n        status: \"sent\",\n        sentAt: new Date().toISOString(),\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n        openCount: 0,\n        clickCount: 0,\n      });\n    }\n\n    // ✅ Send emails individually with tracking\n    for (const recipient of recipients) {\n      const trackedBody = trackLinks(body, emailDoc._id);\n\n      const pixel = `<img src=\"${process.env.NEXT_PUBLIC_BASE_URL}/api/open?id=${emailDoc._id}\" width=\"1\" height=\"1\" style=\"display:none;\" />`;\n\n      await transporter.sendMail({\n        from: `\"${senderName || \"CRM\"}\" <${process.env.MAIL_USER}>`,\n        replyTo: decoded.email,\n        to: recipient,\n        subject,\n        html: trackedBody + pixel,\n      });\n    }\n\n    return NextResponse.json({ success: true, id: emailDoc._id });\n  } catch (error: any) {\n    console.error(\"Send email error:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}